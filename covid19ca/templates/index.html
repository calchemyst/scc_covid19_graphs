<!DOCTYPE html>
<html>
<head>
    <title>Covid-19 Graphs</title>
<style>
    select {
        width: 200px;
    }
    button {
        width: 200px;
    }
</style>
</head>
<body>
<script type=text/javascript>
var fips_county = {{ fips_county_mapping | tojson | safe}};
var chart_types = {{ chart_types | tojson| safe }};

function titleCase(str) {
    var splits = str.split(' ');
    for (var i = 0; i < splits.length; i++) {
        splits[i] = splits[i].charAt(0).toUpperCase() + splits[i].substring(1);
    }
    return splits.join(' ');
}

function initPlaces() {
    var placeSelect = document.getElementById("places");
    for (var county in fips_county) {
        placeSelect.add(new Option(county, fips_county[county]));
    }
}

function initChartTypes() {
    var chartTypeSelect = document.getElementById("chart_types");
    for (var i in chart_types) {
        chart_type = chart_types[i];
        chart_type_pretty = titleCase(chart_type.replace(/_/g," "));
        chartTypeSelect.add(new Option(chart_type_pretty, chart_type));
    }
}

function init() {
    initPlaces();
    initChartTypes();
}

function getSelectedOptions(sel) {
    var opts = [], opt;
    for (var i=0, len=sel.options.length; i<len; i++) {
        opt = sel.options[i];
        if (opt.selected) {
            opts.push(opt.value);
        }
    }
    return opts;
}

async function postData(url = '', data = {}) {
  const response = await fetch(url, {
    method: 'POST', // *GET, POST, PUT, DELETE, etc.
    mode: 'cors', // no-cors, *cors, same-origin
    cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
    credentials: 'same-origin', // include, *same-origin, omit
    headers: {
      'Content-Type': 'application/json'
    },
    redirect: 'follow', // manual, *follow, error
    referrerPolicy: 'no-referrer', // no-referrer, *client
    body: data
  });
  return await response.json(); // parses JSON response into native JavaScript objects
}

function graph() {
    var placeSelect = document.getElementById("places");
    var chartTypeSelect = document.getElementById("chart_types");
    var status = document.getElementById("status");
    var places = getSelectedOptions(placeSelect);
    if (places.length == 0) {
        status.style.color="red";
        status.innerHTML = "No counties selected!"
    }
    var chart_type = getSelectedOptions(chartTypeSelect)[0];

    var data = JSON.stringify({
        "chart":chart_type,
        "counties": places
    });

    var covidgraph = document.getElementById("covid_graph");

    covidgraph.src="static/please-wait.svg"

    postData("/graph", data).then((resp)=> {
        if (resp.hasOwnProperty('covid_graph')) {
            covidgraph.src = resp.covid_graph;
        } else {
            status.innerHTML = resp.error;
            covidgraph.src="static/error.svg";
        }
    }).catch((error) => {
        covidgraph.src="static/error.svg";
    });
}

function updateSelection() {
    var placeSelect = document.getElementById("places");
    var status = document.getElementById("status");
    var selected = getSelectedOptions(placeSelect);
    if (selected.length > {{max_counties}}) {
        status.style.color="red";
        status.innerHTML = selected.length + " counties selected (max {{max_counties}})";
    } else {
        status.style.color="";
        status.innerHTML = selected.length + " counties selected.";
    }
}

window.onload = init;
</script>
<div id="latest">Latest date: {{ latest_date }}</div>
<select id="chart_types"></select><br/>
<select id="places" multiple size="20" onchange="updateSelection()"></select>
<div id="status">Select up to {{max_counties}} counties with (macos)âŒ˜+click or (others)ctrl+click.</div>
<br/><br/>
<button onclick="graph()">Graph!</button>
<br/>
<br/>
<img id="covid_graph" src="static/base-placeholder.svg" alt="COVID19 Graph">
</body>
</html>